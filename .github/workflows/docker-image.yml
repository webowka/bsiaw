name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # --- Python + pytest ---
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest

  run-pytest:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest

    - name: "Run Unit Tests"
      run: pytest -v unit_tests.py

    - name: Log in to GitHub Container Registry
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Docker image
      run: |
        IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}"
        TIMESTAMP=$(date +%s)

        docker build . --file Dockerfile \
          --tag $IMAGE_NAME:latest \
          --tag $IMAGE_NAME:$TIMESTAMP

        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
        echo "IMAGE_TAG=$TIMESTAMP" >> $GITHUB_ENV

    - name: Push Docker image
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        docker push $IMAGE_NAME:latest
        docker push $IMAGE_NAME:$IMAGE_TAG

        echo "Pushed image: $IMAGE_NAME:latest"
        echo "Pushed image: $IMAGE_NAME:$IMAGE_TAG"

  trivy-scan:
    runs-on: ubuntu-latest
    needs: run-pytest

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image for scanning
      run: |
        docker build . --file Dockerfile --tag local-image:scan

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'local-image:scan'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy vulnerability scanner (table output)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'local-image:scan'
        format: 'table'
        severity: 'CRITICAL,HIGH'

  nikto-scan:
    runs-on: ubuntu-latest
    needs: run-pytest

    steps:
    - uses: actions/checkout@v4

    - name: Build and run Docker container
      run: |
        docker build . --file Dockerfile --tag test-app:latest
        docker run -d -p 8080:8080 --name test-container test-app:latest
        sleep 10

    - name: Run Nikto web vulnerability scanner
      run: |
        docker run --network host secfigo/nikto:latest -h http://localhost:8080 -output /tmp/nikto-report.txt || true

    - name: Display Nikto results
      if: always()
      run: |
        echo "Nikto scan completed. Check the logs above for results."

    - name: Stop container
      if: always()
      run: docker stop test-container && docker rm test-container

  discord-notification:
    runs-on: ubuntu-latest
    needs: [trivy-scan, nikto-scan]
    
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Send Discord Notification
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.WEBHOOK_URL }}
        title: "Docker Image Built Successfully"
        description: "New Docker image has been built and pushed"
        color: 0x00ff00
