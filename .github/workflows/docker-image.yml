name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest

    - name: Run Unit Tests
      run: pytest -v unit_tests.py

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag test-app:latest

  security-scans:
    runs-on: ubuntu-latest
    needs: build-and-test
    permissions:
      security-events: write

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag scan-image:latest

    # Trivy scan
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'scan-image:latest'
        format: 'json'
        output: 'trivy-results.json'

    - name: Run Trivy SARIF scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'scan-image:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    # Nikto scan
    - name: Start application container
      run: |
        docker run -d -p 8080:8080 --name test-app scan-image:latest
        sleep 10

    - name: Run Nikto scan
      run: |
        mkdir -p nikto-reports
        docker run --network host -v $(pwd)/nikto-reports:/reports secfigo/nikto:latest \
          -h http://localhost:8080 \
          -Format json \
          -output /reports/nikto-report.json || echo "Nikto scan completed"

    - name: Stop container
      if: always()
      run: docker stop test-app && docker rm test-app

  sign-artifacts:
    runs-on: ubuntu-latest
    needs: security-scans
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read

    steps:
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.5.0

    - name: Download scan results
      uses: actions/download-artifact@v4
      with:
        name: security-scan-results
        path: ./security-reports/

    - name: Create and sign security reports
      run: |
        tar -czf security-reports.tar.gz security-reports/
        sha256sum security-reports.tar.gz > security-reports.tar.gz.sha256
        cosign sign-blob --yes \
          --bundle security-reports.tar.gz.bundle \
          security-reports.tar.gz

    - name: Upload signed artifacts
      uses: actions/upload-artifact@v4
      with:
        name: signed-security-reports
        path: |
          security-reports.tar.gz
          security-reports.tar.gz.sha256
          security-reports.tar.gz.bundle
        retention-days: 90

  notify-discord:
    runs-on: ubuntu-latest
    needs: sign-artifacts
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Send Discord Notification
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.WEBHOOK_URL }}
        title: "Pipeline Complete!"
        description: "Build, tests, security scans, and artifact signing completed successfully"
        color: 0x5a03fc