name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest

    - name: Run Unit Tests
      run: pytest -v unit_tests.py

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag test-app:latest

  scan-and-sign:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      id-token: write
      contents: read

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag scan-image:latest

    # Trivy scan
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'scan-image:latest'
        format: 'json'
        output: 'trivy-results.json'

    - name: Run Trivy SARIF scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'scan-image:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    # ZAP scan
    - name: Start application container
      run: |
        docker run -d --network host --name test-app scan-image:latest
        echo "Waiting for application to start..."
        sleep 15
        
        # Check container status
        echo "=== Container Status ==="
        docker ps -a
        
        # Check container logs
        echo "=== Container Logs ==="
        docker logs test-app
        
        # Test connectivity with retries
        echo "=== Testing application endpoint ==="
        for i in {1..10}; do
          if curl -f http://localhost:8000; then
            echo "Application is responding!"
            break
          else
            echo "Attempt $i: Application not responding yet, waiting 3 seconds..."
            sleep 3
          fi
        done
        
        # Final verification
        echo "=== Final verification ==="
        curl -v http://localhost:8000 || (echo "ERROR: Application failed to start" && docker logs test-app && exit 1)

    - name: Run OWASP ZAP scan
      run: |
        mkdir -p zap-reports
        chmod 777 zap-reports
        
        # Verify app is accessible
        echo "Testing application before ZAP scan..."
        curl -I http://localhost:8000 || echo "Warning: App might not be responding"
        
        # Run ZAP baseline scan directly to zap-reports directory
        echo "Starting ZAP scan..."
        docker run --network host -v $(pwd)/zap-reports:/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
          -t http://localhost:8000 \
          -J zap-report.json \
          -w zap-report.md \
          -r zap-report.html \
          || echo "ZAP scan completed"
        
        # Check what was created
        echo "Contents of zap-reports directory:"
        ls -lha zap-reports/
        
        # Show report content if available
        if [ -f zap-reports/zap-report.md ]; then
          echo "=== ZAP Report Summary ==="
          head -30 zap-reports/zap-report.md
        else
          echo "No reports generated - creating placeholder"
          echo "ZAP scan was attempted but produced no output" > zap-reports/scan-log.txt
        fi

    - name: Stop container
      if: always()
      run: docker stop test-app && docker rm test-app

    # Sign artifacts
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.5.0

    - name: Create and sign security reports
      run: |
        mkdir -p security-reports
        mv trivy-results.json security-reports/
        mv zap-reports security-reports/
        tar -czf security-reports.tar.gz security-reports/
        sha256sum security-reports.tar.gz > security-reports.tar.gz.sha256
        cosign sign-blob --yes \
          --bundle security-reports.tar.gz.bundle \
          security-reports.tar.gz

    - name: Upload signed artifacts
      uses: actions/upload-artifact@v4
      with:
        name: signed-security-reports
        path: |
          security-reports.tar.gz
          security-reports.tar.gz.sha256
          security-reports.tar.gz.bundle
        retention-days: 90

  notify-discord:
    runs-on: ubuntu-latest
    needs: scan-and-sign
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Send Discord Notification
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.WEBHOOK_URL }}
        title: "Pipeline Complete!"
        description: "Build, tests, security scans, and artifact signing completed successfully"
        color: 0x5a03fc