name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build . --file Dockerfile --tag forum-app:latest

    - name: Save Docker image
      run: docker save forum-app:latest | gzip > forum-app.tar.gz

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: forum-app.tar.gz
        retention-days: 1

  unit-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest

    - name: Run Unit Tests
      run: pytest -v unit_tests.py

  integration-tests:
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5434:5432

    steps:
    - uses: actions/checkout@v4

    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Load Docker image
      run: docker load < forum-app.tar.gz

    - name: Start application container
      run: |
        docker run -d --network host --name test-app \
          -e DATABASE_URL="postgresql://testuser:testpass@localhost:5434/testdb" \
          -e SECRET_KEY="test-secret-key-for-integration-tests-min-32-characters" \
          -e ADMIN_USERNAME="admin" \
          -e ADMIN_PASSWORD="admin123" \
          -e ADMIN_EMAIL="admin@forum.local" \
          -p 8001:8000 \
          forum-app:latest

        echo "Waiting for application to start..."
        sleep 15

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install test dependencies
      run: |
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run Integration Tests
      env:
        TEST_DATABASE_URL: postgresql://testuser:testpass@localhost:5434/testdb
        TEST_BASE_URL: http://localhost:8001
      run: |
        pytest tests/ -v --tb=short

    - name: Show application logs on failure
      if: failure()
      run: docker logs test-app

    - name: Stop container
      if: always()
      run: |
        docker stop test-app 2>/dev/null || true
        docker rm test-app 2>/dev/null || true

  security-scans:
    runs-on: ubuntu-latest
    needs: [build, unit-tests, integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      id-token: write
      contents: read
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: authdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v4

    - name: Download Docker image
      uses: actions/download-artifact@v4
      with:
        name: docker-image

    - name: Load Docker image
      run: |
        docker load < forum-app.tar.gz
        docker tag forum-app:latest scan-image:latest

    # Trivy scan - FAIL if scan execution fails
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'scan-image:latest'
        format: 'json'
        output: 'trivy-results.json'
        exit-code: '0'  # Don't fail on vulnerabilities found
        severity: 'HIGH,CRITICAL'

    - name: Run Trivy SARIF scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'scan-image:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '0'  # Don't fail on vulnerabilities found

    - name: Upload Trivy to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    # ZAP scan - simplified startup and FAIL on issues
    - name: Start application container
      run: |
        docker run -d --network host --name test-app \
          -e DATABASE_URL="postgresql://user:password@localhost:5432/authdb" \
          -e SECRET_KEY="test-secret-key-for-ci-pipeline-min-32-characters-long" \
          -e ADMIN_USERNAME="admin" \
          -e ADMIN_PASSWORD="admin123" \
          -e ADMIN_EMAIL="admin@forum.local" \
          scan-image:latest
        
        echo "Waiting for application to start..."
        sleep 15
        
        # Simple connectivity check - fail if not responding
        if ! curl -f http://localhost:8000; then
          echo "ERROR: Application failed to start"
          docker logs test-app
          exit 1
        fi
        echo "Application is ready"

    - name: Run OWASP ZAP scan
      run: |
        mkdir -p zap-reports
        chmod 777 zap-reports
        
        # Run ZAP baseline scan - ignore exit code from findings
        set +e
        docker run --network host -v $(pwd)/zap-reports:/zap/wrk/:rw \
          ghcr.io/zaproxy/zaproxy:stable zap-baseline.py \
          -t http://localhost:8000 \
          -J zap-report.json \
          -w zap-report.md \
          -r zap-report.html
        ZAP_EXIT_CODE=$?
        set -e
        
        echo "ZAP scan completed with exit code: $ZAP_EXIT_CODE"
        
        # Only verify that reports were created - that means scan executed successfully
        if [ ! -f zap-reports/zap-report.json ]; then
          echo "ERROR: ZAP scan failed to execute - no reports generated"
          exit 1
        fi
        
        echo "ZAP scan executed successfully - reports generated"

    - name: Stop container
      if: always()
      run: |
        docker stop test-app 2>/dev/null || true
        docker rm test-app 2>/dev/null || true

    # Sign artifacts with restricted access
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.5.0

    - name: Create and sign security reports
      run: |
        # Generate date stamp for artifact naming
        DATE_STAMP=$(date +%Y%m%d-%H%M%S)
        ARTIFACT_NAME="security-reports-${DATE_STAMP}"
        
        mkdir -p security-reports
        mv trivy-results.json security-reports/
        mv zap-reports security-reports/
        tar -czf ${ARTIFACT_NAME}.tar.gz security-reports/
        sha256sum ${ARTIFACT_NAME}.tar.gz > ${ARTIFACT_NAME}.tar.gz.sha256
        cosign sign-blob --yes \
          --bundle ${ARTIFACT_NAME}.tar.gz.bundle \
          ${ARTIFACT_NAME}.tar.gz
        
        # Save artifact name for upload step
        echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> $GITHUB_ENV

    - name: Upload signed artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: |
          ${{ env.ARTIFACT_NAME }}.tar.gz
          ${{ env.ARTIFACT_NAME }}.tar.gz.sha256
          ${{ env.ARTIFACT_NAME }}.tar.gz.bundle
        retention-days: 90

  notify-discord:
    runs-on: ubuntu-latest
    needs: security-scans
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Send Discord Notification
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.WEBHOOK_URL }}
        title: "Pipeline Complete!"
        description: "Build, unit tests, integration tests, security scans, and artifact signing completed successfully"
        color: 0x5a03fc